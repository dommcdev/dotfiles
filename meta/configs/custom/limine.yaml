- shell:
  - |
    # Guard: Ensure Limine is actually installed first
    if ! command -v limine &>/dev/null; then
        echo "Error: Limine is not installed. Please install it first (or use archinstall)."
        exit 1
    fi

    echo "Upgrading Limine to 'Set and Forget' mode..."
    
    # 1. Install Automation Tools
    yay -S --noconfirm --needed limine-mkinitcpio-hook limine-snapper-sync

    # 2. Setup /etc/default/limine (The Controller)
    CMDLINE=""
    # Check existing configs
    for conf in /boot/limine.conf /boot/EFI/limine/limine.conf; do
        if [[ -f "$conf" ]]; then
             CMDLINE=$(grep "cmdline:" "$conf" | head -1 | sed 's/.*cmdline:[[:space:]]*//')
             [[ -n "$CMDLINE" ]] && break
        fi
    done
    
    # Fallback to running system kernel parameters
    if [[ -z "$CMDLINE" ]]; then
        CMDLINE=$(cat /proc/cmdline | sed -E 's/(BOOT_IMAGE|initrd)=[^ ]*//g' | tr -s ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    fi

    echo "Detected Kernel Cmdline: $CMDLINE"

    sudo cp limine/default.conf /etc/default/limine
    sudo sed -i "s|@@CMDLINE@@|$CMDLINE|g" /etc/default/limine
    
    # Remove Legacy/Non-EFI flags if we aren't on EFI
    if [[ ! -d /sys/firmware/efi ]]; then
        sudo sed -i '/^ENABLE_UKI=/d; /^ENABLE_LIMINE_FALLBACK=/d' /etc/default/limine
    fi

    # 3. Setup /boot/limine.conf (The Theme)
    # We copy this FIRST, assuming limine-update respects existing settings (Omarchy style)
    sudo cp limine/limine.conf /boot/limine.conf

    # 4. Enable Automation
    sudo systemctl enable --now limine-snapper-sync.service

    # 5. Regenerate
    echo "Regenerating boot entries..."
    sudo limine-update
    sudo limine-snapper-sync
    
    echo "Limine upgrade complete!"
