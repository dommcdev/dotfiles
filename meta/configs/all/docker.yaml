
- link: {}

- shell:
  - |
    if [[ "$(./sys id)" == "arch" ]]; then
      sudo pacman -S --noconfirm --needed docker docker-compose lazydocker
    elif [[ "$(./sys id)" == "ubuntu" ]]; then
      curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
      sudo sh /tmp/get-docker.sh
      brew install lazydocker
    elif [[ "$(./sys id)" == "mac" ]]; then
      brew install docker docker-compose lazydocker
    fi

  - |
    if [[ "$(./sys type)" == "Linux" ]]; then
      # Limit Docker log sizes to avoid filling disk
      sudo mkdir -p /etc/docker
      sudo tee /etc/docker/daemon.json >/dev/null <<'DEOF'
    {
      "log-driver": "json-file",
      "log-opts": { "max-size": "10m", "max-file": "5" }
    }
    DEOF

      # Prevent Docker from blocking boot on network-online.target
      sudo mkdir -p /etc/systemd/system/docker.service.d
      sudo tee /etc/systemd/system/docker.service.d/no-block-boot.conf >/dev/null <<'DEOF'
    [Unit]
    DefaultDependencies=no
    DEOF

      sudo systemctl enable --now docker
      sudo usermod -aG docker $USER
      sudo systemctl daemon-reload

      # let libvirt traffic through
      sudo iptables -C DOCKER-USER -i virbr0 -j ACCEPT 2>/dev/null || \
      sudo iptables -I DOCKER-USER -i virbr0 -j ACCEPT
      sudo iptables -C DOCKER-USER -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
      sudo iptables -I DOCKER-USER -o virbr0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    fi
