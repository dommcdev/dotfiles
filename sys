#!/usr/bin/env bash
set -euo pipefail

# --- Detect OS ---
if [[ "$(uname -s)" == "Darwin" ]]; then
    ID="macos"
else
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        # ID is already set by sourcing the file
    else
        ID="unknown"
    fi
fi

# --- Detect Power Status ---
# 0 for wall power, 1 for battery
POWER=0
if [[ "$ID" == "macos" ]]; then
    if pmset -g batt | grep -q "InternalBattery"; then POWER=1; fi
else
    # Check for any battery device starting with BAT
    if ls /sys/class/power_supply/BAT* >/dev/null 2>&1; then POWER=1; fi
fi

# --- Output ---
case "${1:-all}" in
    id)    echo "$ID" ;;
    power) echo "$POWER" ;;
    all)   echo "os=$ID power=$POWER" ;;
    *)     echo "Usage: $0 {id|power|all}" >&2; exit 1 ;;
esac
