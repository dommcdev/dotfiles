#!/usr/bin/env bash

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
  echo -e "${GREEN}$1${NC}"
}

print_error() {
  echo -e "${RED}$1${NC}"
}

print_info() {
  echo -e "${YELLOW}$1${NC}"
}

SYS_CMD="$HOME/.local/bin/sys"
OS_ID=$("$SYS_CMD" id)

check_fingerprint_hardware() {
  # Get fingerprint devices for the user
  # Suppress stderr to avoid confusion if service isn't ready immediately
  local devices
  devices=$(fprintd-list "$USER" 2>/dev/null || true)

  # Exit if no devices found
  if [[ -z "$devices" ]] || [[ "$devices" == *"No devices available"* ]]; then
    print_error "\nNo fingerprint sensor detected."
    return 1
  fi
  return 0
}

install_packages() {
  print_info "Checking required packages for $OS_ID..."
  
  case "$OS_ID" in
    arch)
      # Check if installed to be fast/idempotent
      if ! pacman -Qi fprintd &>/dev/null || ! pacman -Qi usbutils &>/dev/null; then
        print_info "Installing packages (Arch)..."
        sudo pacman -S --noconfirm --needed fprintd usbutils
      else
        print_success "Packages already installed."
      fi
      ;;
    ubuntu)
      if ! dpkg -s fprintd libpam-fprintd usbutils &>/dev/null; then
        print_info "Installing packages (Ubuntu)..."
        sudo apt update
        sudo apt install -y fprintd libpam-fprintd usbutils
      else
        print_success "Packages already installed."
      fi
      ;;
    fedora)
      if ! rpm -q fprintd fprintd-pam usbutils &>/dev/null; then
        print_info "Installing packages (Fedora)..."
        sudo dnf install -y fprintd fprintd-pam usbutils
      else
        print_success "Packages already installed."
      fi
      ;;
    *)
      print_error "Unsupported OS for automated package installation: $OS_ID"
      exit 1
      ;;
  esac
}

remove_packages() {
  print_info "Removing packages for $OS_ID..."
  case "$OS_ID" in
    arch)
      sudo pacman -Rns --noconfirm fprintd usbutils 2>/dev/null || true
      ;;
    ubuntu)
      sudo apt-get remove -y fprintd libpam-fprintd usbutils || true
      ;;
    fedora)
      sudo dnf remove -y fprintd fprintd-pam usbutils || true
      ;;
    *)
      print_error "Unsupported OS for automated package removal: $OS_ID"
      ;;
  esac
}

setup_pam_config() {
  # Configure sudo
  if ! grep -q pam_fprintd.so /etc/pam.d/sudo; then
    print_info "Configuring sudo for fingerprint authentication..."
    sudo sed -i '1i auth    sufficient pam_fprintd.so' /etc/pam.d/sudo
  else
    print_success "Sudo PAM already configured."
  fi

  # Configure polkit
  if [ -f /etc/pam.d/polkit-1 ] && ! grep -q 'pam_fprintd.so' /etc/pam.d/polkit-1; then
    print_info "Configuring polkit for fingerprint authentication..."
    sudo sed -i '1i auth      sufficient pam_fprintd.so' /etc/pam.d/polkit-1
  elif [ ! -f /etc/pam.d/polkit-1 ]; then
    print_info "Creating polkit configuration with fingerprint authentication..."
    sudo tee /etc/pam.d/polkit-1 >/dev/null <<'EOF'
auth      sufficient pam_fprintd.so
auth      required pam_unix.so
account   required pam_unix.so
password  required pam_unix.so
session   required pam_unix.so
EOF
  else
    print_success "Polkit PAM already configured."
  fi
}

remove_pam_config() {
  # Remove from sudo
  if grep -q pam_fprintd.so /etc/pam.d/sudo; then
    print_info "Removing fingerprint authentication from sudo..."
    sudo sed -i '/pam_fprintd\.so/d' /etc/pam.d/sudo
  fi

  # Remove from polkit
  if [ -f /etc/pam.d/polkit-1 ] && grep -Fq 'pam_fprintd.so' /etc/pam.d/polkit-1; then
    print_info "Removing fingerprint authentication from polkit..."
    sudo sed -i '/pam_fprintd\.so/d' /etc/pam.d/polkit-1
  fi
}

get_enrolled_fingers() {
  local output
  output=$(fprintd-list "$USER" 2>/dev/null || true)
  local enrolled_list=""
  
  if echo "$output" | grep -q "right-index-finger"; then enrolled_list+="Right Index, "; fi
  if echo "$output" | grep -q "right-middle-finger"; then enrolled_list+="Right Middle, "; fi
  if echo "$output" | grep -q "right-thumb"; then enrolled_list+="Right Thumb, "; fi
  if echo "$output" | grep -q "right-ring-finger"; then enrolled_list+="Right Ring, "; fi
  if echo "$output" | grep -q "right-little-finger"; then enrolled_list+="Right Little, "; fi
  if echo "$output" | grep -q "left-index-finger"; then enrolled_list+="Left Index, "; fi
  if echo "$output" | grep -q "left-middle-finger"; then enrolled_list+="Left Middle, "; fi
  if echo "$output" | grep -q "left-thumb"; then enrolled_list+="Left Thumb, "; fi
  if echo "$output" | grep -q "left-ring-finger"; then enrolled_list+="Left Ring, "; fi
  if echo "$output" | grep -q "left-little-finger"; then enrolled_list+="Left Little, "; fi
  
  enrolled_list=${enrolled_list%, }
  
  if [[ -z "$enrolled_list" ]]; then
      echo "None"
  else
      echo "$enrolled_list"
  fi
}

enroll_fingerprints() {
  print_success "\nStarting Fingerprint Enrollment"
  
  if ! command -v gum &>/dev/null; then
     print_error "Error: 'gum' is not installed. Please install gum to use the interactive enrollment."
     exit 1
  fi

  while true; do
    echo "" # Spacing
    
    local enrolled
    enrolled=$(get_enrolled_fingers)
    echo -e "${YELLOW}Enrolled: ${NC}${enrolled}"
    
    local choice
    if ! choice=$(gum choose --header "Select finger to enroll (Esc to finish)" \
      "Right Index" "Right Middle" "Right Thumb" "Right Ring" "Right Little" \
      "Left Index" "Left Middle" "Left Thumb" "Left Ring" "Left Little"); then
      break
    fi

    local finger_id=""
    case "$choice" in
      "Right Index")  finger_id="right-index-finger" ;;
      "Right Middle") finger_id="right-middle-finger" ;;
      "Right Thumb")  finger_id="right-thumb" ;;
      "Right Ring")   finger_id="right-ring-finger" ;;
      "Right Little") finger_id="right-little-finger" ;;
      "Left Index")   finger_id="left-index-finger" ;;
      "Left Middle")  finger_id="left-middle-finger" ;;
      "Left Thumb")   finger_id="left-thumb" ;;
      "Left Ring")    finger_id="left-ring-finger" ;;
      "Left Little")  finger_id="left-little-finger" ;;
    esac

    print_info "Enrolling $choice..."
    print_info "Please scan your finger repeatedly on the sensor until completion."
    
    # -f forces enrollment even if finger is already enrolled
    if sudo fprintd-enroll -f "$finger_id" "$USER"; then
      gum style --foreground 212 "Successfully enrolled $choice!"
      sleep 2
    else
      gum style --foreground 196 "Failed to enroll $choice."
      if ! gum confirm "Try again?"; then
         continue
      fi
    fi
  done
}

main() {
  if [[ "${1:-}" == "--remove" ]]; then
    print_success "Removing fingerprint scanner from authentication.\n"
    remove_pam_config
    remove_packages
    print_success "Fingerprint authentication has been removed."
  else
    print_success "Setting up fingerprint scanner for authentication.\n"
    
    install_packages
    
    if ! check_fingerprint_hardware; then
      print_error "Hardware check failed."
      exit 1
    fi
    
    setup_pam_config
    enroll_fingerprints
  fi
}

main "$@"
