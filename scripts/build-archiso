#!/bin/env bash

# A script to create a custom Arch Linux live ISO using archiso

# --- Configuration ---
mkdir -p ~/dev/external

# The directory where the archiso repository will be cloned.
ARCHISO_REPO_DIR="$HOME/dev/external/archiso"

# The directory where the final ISO will be saved.
OUTPUT_DIR="$HOME/dev/external"

# Directory for building the archiso
ARCHISO_BUILD_DIR="$ARCHISO_REPO_DIR/my-archiso"

# The archiso profile to use. We'll use the 'releng' profile as requested.
ARCHISO_PROFILE="releng"

# Location of files to place in iso
SOURCE_DIR="$HOME/dev/dotfiles/arch/archinstall"


# --- Functions ---

# Function to check for required packages and install them if they are not present.
install_dependencies() {
    echo "--- Checking for required dependencies... ---"

    # List of required packages.
    local packages=("archiso" "git")

    for package in "${packages[@]}"; do
        # Use pacman's -Q to check if the package is installed.
        if ! pacman -Q "$package" &>/dev/null; then
            echo "Package '$package' not found. Installing it now..."
            # -S: Sync packages from the repositories
            # --noconfirm: Skip the confirmation prompt
            # --needed: Only install if not already installed
            sudo pacman -S --noconfirm --needed "$package"
            if [ $? -ne 0 ]; then
                echo "ERROR: Failed to install '$package'. Exiting."
                exit 1
            fi
        else
            echo "Package '$package' is already installed."
        fi
    done

    echo "--- All dependencies are installed. ---"
}

# Function to clone or update the archiso repository.
manage_archiso_repo() {
    echo "--- Managing the archiso repository... ---"

    # Check if the repository directory already exists.
    if [ -d "$ARCHISO_REPO_DIR" ]; then
        echo "Archiso repository directory found at '$ARCHISO_REPO_DIR'."
        echo "Performing a git pull to update the repository..."

        # Navigate into the repository directory.
        pushd "$ARCHISO_REPO_DIR" > /dev/null

        # Perform a git pull.
        git pull
        if [ $? -ne 0 ]; then
            echo "ERROR: Failed to update the archiso repository. Exiting."
            popd > /dev/null
            exit 1
        fi

        # Return to the original directory.
        popd > /dev/null
    else
        echo "Archiso repository directory not found. Cloning it now..."

        # Clone the repository.
        git clone https://gitlab.archlinux.org/archlinux/archiso.git "$ARCHISO_REPO_DIR"
        if [ $? -ne 0 ]; then
            echo "ERROR: Failed to clone the archiso repository. Exiting."
            exit 1
        fi
    fi

    echo "--- Archiso repository is ready. ---"
}

# Function to prepare the working directory and copy custom files.
prepare_build_environment() {
    echo "--- Preparing the build environment... ---"

    # Clean up any previous build directory
    # Note - this dir should not exist, since this script deletes it after generating iso
    if [ -d "$ARCHISO_BUILD_DIR" ]; then
        echo "Removing previous build directory '$ARCHISO_BUILD_DIR'..."
        sudo rm -rf "$ARCHISO_BUILD_DIR"
    fi

    # Copy the chosen profile to our working directory.
    echo "Copying the '$ARCHISO_PROFILE' profile to '$ARCHISO_BUILD_DIR'..."
    cp -r "$ARCHISO_REPO_DIR/configs/releng" "$ARCHISO_BUILD_DIR"
    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to copy the archiso profile. Exiting."
        exit 1
    fi

    # Copy archinstall configs and bootstrap-arch.sh
    if [ ! -d "$SOURCE_DIR" ]; then
      echo "Error: The source directory '$SOURCE_DIR' does not exist." >&2
      echo "Please clone your dotfiles repository to '~/dev/dotfiles' before running!" >&2
      exit 1
    fi

    echo "Copying contents from '$SOURCE_DIR' to airootfs..."
    cp -r "$SOURCE_DIR"/* "$ARCHISO_REPO_DIR/my-archiso/airootfs/root"
    if [ $? -eq 0 ]; then
      echo "Successfully copied the files."
    else
      echo "Error: Failed to copy the files." >&2
      exit 1
    fi

    echo "--- Build environment is prepared. ---"
}

# Function to build the ISO and move it to the final output directory.
build_and_move_iso() {
    echo "--- Starting the ISO build process... ---"

    # Navigate to the custom profile directory.
    pushd "$ARCHISO_BUILD_DIR" > /dev/null

    # Run `mkarchiso` to build the ISO.
    # -v: Verbose output
    # -w: Working directory
    # -o: Output directory
    # The final argument is the profile directory to use (which we are currently in).
    sudo mkarchiso -v -w "$ARCHISO_BUILD_DIR/work" -o "$OUTPUT_DIR" .
    echo "Removing build directory '$ARCHISO_BUILD_DIR'..."
    sudo rm -rf "$ARCHISO_BUILD_DIR"

    if [ $? -ne 0 ]; then
        echo "ERROR: ISO creation failed. Check the output above for details."
        popd > /dev/null
        exit 1
    fi

    # Return to the original directory.
    popd > /dev/null

    echo "--- ISO build process complete. ---"
}

# --- Main script execution ---

echo "--- Archiso Custom ISO Builder Script ---"

# 1. Install dependencies
install_dependencies

# 2. Clone or update the archiso repository
manage_archiso_repo

# 3. Prepare the build environment with the releng template
prepare_build_environment

# 4. Ensure the output directory exists
echo "--- Ensuring output directory exists... ---"
mkdir -p "$OUTPUT_DIR"
if [ ! -d "$OUTPUT_DIR" ]; then
    echo "ERROR: Failed to create output directory '$OUTPUT_DIR'. Exiting."
    exit 1
fi
echo "Output directory '$OUTPUT_DIR' is ready."

# 5. Build the ISO and move it to the output directory
build_and_move_iso

echo "--- Script finished successfully! ---"
echo "Your new Archiso ISO should be located at '$OUTPUT_DIR'."
eza "$OUTPUT_DIR"
