#!/usr/bin/env bash

# Define the display ID for ddcutil (might have to adjust)
DDCUTIL_TARGET="--display 1"

# --- Helper Functions ---

# Function to get the current brightness value.
get_current_brightness() {
    ddcutil getvcp 10 $DDCUTIL_TARGET 2>/dev/null | grep -oP 'current value =\s+\K\d+'
}

# Function to send a desktop notification.
# Usage: send_notification <value> <message_prefix>
send_notification() {
    local value="$1"
    local prefix="$2"
    notify-send \
        -h string:x-canonical-private-synchronous:brightness \
        -h int:value:"$value" \
        "Monitor Brightness" \
        "${prefix}${value}%" \
        -i "preferences-system-brightness" \
        -t 1500
}

# Function to display usage instructions.
show_usage() {
    echo "Usage: $(basename "$0") <command>"
    echo "  (no command)      Show current brightness"
    echo "  <0-100>           Set absolute brightness (e.g., 75)"
    echo "  [+|-] <value>     Adjust brightness relatively (e.g., + 10)"
}


# === Main Logic: Check number of arguments ===

if [ "$#" -eq 0 ]; then
    # --- GET MODE: No arguments ---
    BRIGHTNESS=$(get_current_brightness)

    if [ -n "$BRIGHTNESS" ]; then
        echo "Current Brightness: ${BRIGHTNESS}%"
        send_notification "$BRIGHTNESS" "Current: "
        echo "" # Add newline
        show_usage
    else
        notify-send "DDCUTIL Error" "Could not get current brightness." -u critical
        exit 1
    fi

elif [ "$#" -eq 1 ]; then
    # --- ABSOLUTE SET MODE: One argument (e.g., 75) ---
    VALUE=$1
    if ! [[ "$VALUE" =~ ^[0-9]+$ ]] || [ "$VALUE" -lt 0 ] || [ "$VALUE" -gt 100 ]; then
        notify-send "DDCUTIL Error" "Value must be a number between 0 and 100." -u critical
        exit 1
    fi

    ddcutil setvcp 10 "$VALUE" $DDCUTIL_TARGET
    send_notification "$VALUE" "Set to: "

elif [ "$#" -eq 2 ]; then
    # --- RELATIVE SET MODE: Two arguments (e.g., + 10) ---
    OPERATOR=$1
    STEP=$2
    if [ "$OPERATOR" != "+" ] && [ "$OPERATOR" != "-" ]; then
        show_usage
        exit 1
    fi

    ddcutil setvcp 10 "$OPERATOR" "$STEP" $DDCUTIL_TARGET
    NEW_BRIGHTNESS=$(get_current_brightness)

    if [ -n "$NEW_BRIGHTNESS" ]; then
        send_notification "$NEW_BRIGHTNESS" "New: "
    else
        # Fallback notification if reading the new value fails
        NOTIF_MESSAGE=$([ "$OPERATOR" == "+" ] && echo "Brightness increased" || echo "Brightness decreased")
        notify-send "Monitor Brightness" "$NOTIF_MESSAGE" -i "preferences-system-brightness" -t 1500
    fi
else
    # --- INVALID USAGE: Too many arguments ---
    show_usage
    exit 1
fi
