#!/usr/bin/env bash
set -euo pipefail

# --- Bold Color Definitions ---
NC='\033[0m'
BOLD='\033[1m'
WHITE='\033[1;37m'      # Bright/Bold White
GREY='\033[1;30m'       # Bold Grey (Charcoal)
BLUE='\033[1;34m'       # Bold Blue
CYAN='\033[1;36m'       # Bold Cyan (Teal)
ORANGE='\033[0;33m'     # Standard Orange
YELLOW='\033[1;33m'     # Bold Yellow
RED='\033[1;31m'        # Bold Red
PURPLE='\033[1;35m'     # Bold Purple
GREEN='\033[1;32m'      # Bold Green


show_logo() {
    local id=$1
    clear

    case "$id" in
        "arch")
            # All Bold Cyan (Teal)
            printf -- "${CYAN}                   -\`\n"
            printf -- "${CYAN}                  .o+\`\n"
            printf -- "${CYAN}                 \`ooo/\n"
            printf -- "${CYAN}                \`+oooo:\n"
            printf -- "${CYAN}               \`+oooooo:\n"
            printf -- "${CYAN}               -+oooooo+:\n"
            printf -- "${CYAN}             \`/:-:++oooo+:\n"
            printf -- "${CYAN}            \`/++++/+++++++:\n"
            printf -- "${CYAN}           \`/++++++++++++++:\n"
            printf -- "${CYAN}          \`/+++ooooooooooooo/\`\n"
            printf -- "${CYAN}         ./ooosssso++osssssso+\`\n"
            printf -- "${CYAN}        .oossssso-..../ossssss+\`\n"
            printf -- "${CYAN}       -osssssso.      :ssssssso.\n"
            printf -- "${CYAN}      :osssssss/        osssso+++.\n"
            printf -- "${CYAN}     /ossssssss/        +ssssooo/-\n"
            printf -- "${CYAN}   \`/ossssso+/:-        -:/+osssso+-\n"
            printf -- "${CYAN}  \`+sso+:-                \`.-/+oso:\n"
            printf -- "${CYAN} \`++:.                           \`-/+/\n"
            printf -- "${CYAN} .\`                                 \`/\n"
            ;;

        "fedora")
            printf -- "${BLUE}               .',;::::;,'..\n"
            printf -- "${BLUE}           .';:cccccccccccc:;,..\n"
            printf -- "${BLUE}       .;cccccccccccccccccccccc;.\n"
            printf -- "${BLUE}     .:cccccccccccccccccccccccccc:.\n"
            printf -- "${BLUE}   .;ccccccccccccc;${WHITE}.:dddl:.${BLUE};ccccccc;.\n"
            printf -- "${BLUE}  .:ccccccccccccc;${WHITE}OWMKOOXMWd${BLUE};ccccccc:.\n"
            printf -- "${BLUE}.:ccccccccccccc;${WHITE}KMMc${BLUE};cc;${WHITE}xMMc${BLUE};ccccccc:.\n"
            printf -- "${BLUE},cccccccccccccc;${WHITE}MMM.${BLUE};cc;${WHITE};WW:${BLUE};cccccccc,\n"
            printf -- "${BLUE}:cccccccccccccc;${WHITE}MMM.${BLUE};cccccccccccccccc:\n"
            printf -- "${BLUE}:ccccccc;${WHITE}oxOOOo${BLUE};${WHITE}MMM000k.${BLUE};cccccccccccc:\n"
            printf -- "${BLUE}cccccc;${WHITE}0MMKxdd:${BLUE};${WHITE}MMMkddc.${BLUE};cccccccccccc;\n"
            printf -- "${BLUE}ccccc;${WHITE}XMO'${BLUE};cccc;${WHITE}MMM.${BLUE};cccccccccccccccc'\n"
            printf -- "${BLUE}ccccc;${WHITE}MMo${BLUE};ccccc;${WHITE}MMW.${BLUE};ccccccccccccccc;\n"
            printf -- "${BLUE}ccccc;${WHITE}0MNc.${BLUE}ccc${WHITE}.xMMd${BLUE};ccccccccccccccc;\n"
            printf -- "${BLUE}cccccc;${WHITE}dNMWXXXWM0:${BLUE};cccccccccccccc:,\n"
            printf -- "${BLUE}cccccccc;${WHITE}.:odl:.${BLUE};cccccccccccccc:.,\n"
            printf -- "${BLUE}ccccccccccccccccccccccccccccc:'.\n"
            printf -- "${BLUE}:cccccccccccccccccccccc:;,..\n"
            printf -- "${BLUE} ':cccccccccccccccc::;,..\n"
            ;;

        "ubuntu")
            # All Bold Red
            printf -- "${RED}                             ....\n"
            printf -- "${RED}               .',:clooo:   .:looooo:.\n"
            printf -- "${RED}            .;looooooooc   .oooooooooo'\n"
            printf -- "${RED}         .;loooooool:,''.   :ooooooooooc\n"
            printf -- "${RED}        ;looool;.          'oooooooooo,\n"
            printf -- "${RED}       ;clool'             .cooooooc.  ,,\n"
            printf -- "${RED}          ...                 ......   .:oo,\n"
            printf -- "${RED} .;clol:,.                         .loooo'\n"
            printf -- "${RED}:ooooooooo,                         'ooool\n"
            printf -- "${RED}'ooooooooooo.                         loooo.\n"
            printf -- "${RED}'ooooooooool                          coooo.\n"
            printf -- "${RED},loooooooc.                         .loooo.\n"
            printf -- "${RED}   .,;;;'.                          ;ooooc\n"
            printf -- "${RED}       ...                          ,ooool.\n"
            printf -- "${RED}    .cooooc.               ..',,'.  .cooo.\n"
            printf -- "${RED}      ;ooooo:.            ;oooooooc.  :l.\n"
            printf -- "${RED}       .coooooc,..       coooooooooo.\n"
            printf -- "${RED}         .:ooooooolc:.  .ooooooooooo'\n"
            printf -- "${RED}           .':loooooo;   ,oooooooooc\n"
            printf -- "${RED}               ..';::c'   .;loooo:'\n"
            ;;

        "macos")
            # Bold Rainbow
            printf -- "${GREEN}                     ..\n"
            printf -- "${GREEN}                  ,xNMM.\n"
            printf "                  ,xNMM.\n"
            printf -- "${GREEN}                .OMMMMo\n"
            printf -- "${GREEN}                lMM\"\n"
            printf -- "${GREEN}      .;loddo:.  .olloddol;.\n"
            printf -- "${GREEN}    cKMMMMMMMMMMNWMMMMMMMMMM0:\n"
            printf -- "${YELLOW} .KMMMMMMMMMMMMMMMMMMMMMMMWd.\n"
            printf -- "${YELLOW} XMMMMMMMMMMMMMMMMMMMMMMMX.\n"
            printf -- "${ORANGE};MMMMMMMMMMMMMMMMMMMMMMMM:\n"
            printf -- "${ORANGE}:MMMMMMMMMMMMMMMMMMMMMMMM:\n"
            printf -- "${RED}.MMMMMMMMMMMMMMMMMMMMMMMMX.\n"
            printf -- "${RED} kMMMMMMMMMMMMMMMMMMMMMMMWd.\n"
            printf -- "${RED} 'XMMMMMMMMMMMMMMMMMMMMMMMMMMk\n"
            printf -- "${PURPLE}  'XMMMMMMMMMMMMMMMMMMMMMMMMK.\n"
            printf -- "${PURPLE}    kMMMMMMMMMMMMMMMMMMMMMMd\n"
            printf -- "${BLUE}     ;KMMMMMMMWXXWMMMMMMMk.\n"
            printf -- "${BLUE}       \"cooc*\"    \"*coo'\"\n"
            ;;

        *)
            # Shaded Bold Penguin
            printf -- "         ${GREY}#####\n"
            printf -- "        ${GREY}#######\n"
            printf -- "        ${GREY}##${WHITE}O${GREY}#${WHITE}O${GREY}##\n"
            printf -- "        ${GREY}#${YELLOW}#####${GREY}#\n"
            printf -- "      ${GREY}##${WHITE}##${YELLOW}###${WHITE}##${GREY}##\n"
            printf -- "     ${GREY}#${WHITE}##########${GREY}##\n"
            printf -- "    ${GREY}#${WHITE}############${GREY}##\n"
            printf -- "    ${GREY}#${WHITE}############${GREY}###\n"
            printf -- "   ${YELLOW}##${GREY}#${WHITE}###########${GREY}##${YELLOW}#\n"
            printf " ${YELLOW}######${GREY}#${WHITE}#######${GREY}#${YELLOW}######\n"
            printf " ${YELLOW}#######${GREY}#${WHITE}#####${GREY}#${YELLOW}#######\n"
            printf "   ${YELLOW}#####${GREY}#######${YELLOW}#####\n"
            ;;
    esac
    printf -- "${NC}\n"
}

update_profiles() {
    bash ./scripts/utilities/generate-profiles.sh &> /dev/null
}

start_sudo_loop() {
    sudo -v

    while true; do
        sudo -n true
        sleep 60
        kill -0 "$$" || exit
    done 2>/dev/null &

    SUDO_LOOP_PID=$!
}

finished() {
    echo
    echo
    echo "Finished installing!"
    echo

    read -p "Would you like to reboot now? [Y/n] " choice
    case "$choice" in
      [yY][eE][sS]|[yY]|"")
        sudo systemctl reboot
        ;;
      *)
        echo "Some changes may require a reboot to take effect."
        exit 0
        ;;
    esac

    # Kill sudo keep-alive loop (technically optional)
    kill "$SUDO_LOOP_PID"
}

while true; do
    CURRENT_ID=$(./sys id)
    CURRENT_POWER=$(./sys power)

    show_logo "$CURRENT_ID"

    # Using BOLD on labels for high contrast
    echo -e "--- ${YELLOW}System Detection${NC} ---"
    echo -e "${BOLD}System ID:${NC} ${CYAN}$CURRENT_ID${NC}"
    echo -e "${BOLD}Hardware: ${NC} ${CYAN}$( [[ "$CURRENT_POWER" == "1" ]] && echo "Laptop" || echo "Desktop" )${NC}"
    echo "----------------------------"
    echo

    read -p "Proceed with current system information? [Y/n]: " CONFIRM_SYS
    CONFIRM_SYS=${CONFIRM_SYS:-y}

    if [[ ! "$CONFIRM_SYS" =~ ^[Yy]$ ]]; then
        echo -e "\n${YELLOW}Manual Override Mode${NC}"
        read -p "Override ID? (Enter to keep '$CURRENT_ID'): " NEW_ID
        [[ -n "$NEW_ID" ]] && ./sys set-id "$NEW_ID"

        read -p "Override Hardware? (1=Laptop, 0=Desktop, Enter to skip): " NEW_POWER
        [[ -n "$NEW_POWER" ]] && ./sys set-power "$NEW_POWER"

        echo -e "\n${BLUE}Refreshing configuration...${NC}"
        sleep 0.5
        continue
    fi

    echo -e "\n${YELLOW}Select Profile Type:${NC}"
    echo "1) Server (cli essentials)"
    echo "2) Desktop (for use with a DE)"
    echo "3) Custom (everything)"
    echo "4) Custom Profile (enter name)"
    echo "5) Build Your Own (select configs)"
    read -p "Enter choice [1-5]: " CHOICE

    target_profile=""
    selected_configs=""

    case "$CHOICE" in
        1) target_profile="${CURRENT_ID}-server" ;;
        2) target_profile="${CURRENT_ID}-de" ;;
        3) target_profile="${CURRENT_ID}-custom" ;;
        4)
            read -p "Enter custom profile name: " custom_name
            if [[ -f "meta/profiles/$custom_name" ]]; then
                target_profile="$custom_name"
            else
                echo -e "${RED}Profile 'meta/profiles/$custom_name' not found.${NC}"
                sleep 2
                continue
            fi
            ;;
        5)
            echo -e "${BLUE}Scanning for configurations...${NC}"
            if ! command -v gum &>/dev/null; then
                 echo -e "${RED}Error: 'gum' is not installed but is required for this feature.${NC}"
                 sleep 2
                 continue
            fi

            available_configs=$(find meta/configs -type f -name "*.yaml" | sed 's|^meta/configs/||' | sed 's|\.yaml$||' | sort)
            # Use gum filter with --no-limit to allow multiple selections.
            # Header provides explicit instructions on how to use it.
            selected_configs=$(echo "$available_configs" | gum filter --no-limit --height 20 --header "TAB to select multiple, ENTER to confirm" --header.foreground 3 --prompt "Select configs > " --cursor-text.foreground 2 --selected-indicator.foreground 2 --match.foreground 4 --show-help)

            if [[ -z "$selected_configs" ]]; then
                echo -e "${YELLOW}No configs selected.${NC}"
                sleep 1
                continue
            fi
            ;;
        *)
            echo -e "${RED}Invalid choice. Please try again.${NC}"
            sleep 1
            continue
            ;;
    esac

    if [[ -n "$target_profile" ]]; then
        read -p "Proceed with installation for $target_profile? (Y/n): " PROCEED
    elif [[ -n "$selected_configs" ]]; then
        echo -e "\n${YELLOW}Selected configurations:${NC}"
        echo "$selected_configs"
        read -p "Proceed with installation? (Y/n): " PROCEED
    else
        continue
    fi

    PROCEED=${PROCEED:-y}

    if [[ "$PROCEED" =~ ^[Yy]$ ]]; then
        start_sudo_loop
        if [[ -n "$target_profile" ]]; then
            echo -e "${GREEN}Starting installation for $target_profile...${NC}"
            update_profiles
            ./meta/install-profile "$target_profile"
        else
            echo -e "${GREEN}Starting installation...${NC}"
            while IFS= read -r config; do
                if [[ -n "$config" ]]; then
                    echo -e "${BLUE}Installing $config...${NC}"
                    ./setup "$config"
                fi
            done <<< "$selected_configs"
        fi
        finished
    else
        echo -e "\n${BLUE}Restarting...${NC}"
        sleep 1
        continue
    fi
done
